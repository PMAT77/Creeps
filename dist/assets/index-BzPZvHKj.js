(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const l=document.querySelector("#MOVEMENT_SMOOTHING");var u=.1;l.value="0.1";l.onchange=()=>{u=Number(l.value)};class f{constructor(t,e,i,s){this.markForRemoval=!1,this.breathPhase=0,this.breathAmplitude=.4,this.breathSpeed=6,this.x=t,this.y=e,this.width=i,this.height=s,this.baseSize=i,this.targetPos={x:Number(t),y:Number(e)},this.currentPos={x:Number(t),y:Number(e)},(isNaN(this.x)||isNaN(this.y))&&(console.error("坐标初始化异常",{x:t,y:e}),this.x=this.targetPos.x=0,this.y=this.targetPos.y=0)}get centerPoint(){return{x:this.x+this.width/2,y:this.y+this.height/2}}calculateMovement(){let t=0,e=0;a.keys.w&&(e-=1),a.keys.s&&(e+=1),a.keys.a&&(t-=1),a.keys.d&&(t+=1);const i=Math.sqrt(t*t+e*e);if(i<Number.EPSILON)return{x:0,y:0};const s=Number.isFinite(t/i)?t/i:0,o=Number.isFinite(e/i)?e/i:0,r=1e-4;return{x:Math.abs(s)>r?s:0,y:Math.abs(o)>r?o:0}}updateMovement(t){const e=Number(t==null?void 0:t.width)||800,i=Number(t==null?void 0:t.height)||600;this.targetPos.x=Math.max(0,Math.min(e-this.width,this.targetPos.x)),this.targetPos.y=Math.max(0,Math.min(i-this.height,this.targetPos.y)),this.currentPos.x+=(this.targetPos.x-this.currentPos.x)*u,this.currentPos.y+=(this.targetPos.y-this.currentPos.y)*u,[this.x,this.y]=[this.currentPos.x,this.currentPos.y]}isIdle(){return Math.abs(this.targetPos.x-this.currentPos.x)<.1&&Math.abs(this.targetPos.y-this.currentPos.y)<.1}updateBreathAnimation(){this.isIdle()&&(this.breathPhase+=a.deltaTime*this.breathSpeed)}update(t,e){try{this.updateBreathAnimation();const i=this.calculateMovement();this.targetPos.x+=i.x*this.speed,this.targetPos.y+=i.y*this.speed,this.updateMovement(t)}catch(i){console.error("Creep update error:",i)}}draw(t){const e=this.centerPoint;t.save();const i=1+Math.sin(this.breathPhase)*this.breathAmplitude/this.baseSize;t.translate(e.x,e.y),t.scale(i,i),t.translate(-e.x,-e.y),t.beginPath(),t.arc(e.x,e.y,this.width/2,0,Math.PI*2),t.fillStyle="#555555",t.fill(),t.beginPath(),t.arc(e.x,e.y,this.width/2+1,0,Math.PI*2),t.lineWidth=2,t.strokeStyle="#000000",t.stroke(),t.beginPath(),t.arc(e.x,e.y,this.width/2+3,0,Math.PI*2),t.lineWidth=4,t.strokeStyle="#222222",t.stroke(),t.beginPath(),t.arc(e.x,e.y,this.width/2+6,0,Math.PI*2),t.lineWidth=2,t.strokeStyle="#555555",t.stroke(),t.restore()}}class p extends f{constructor(t,e,i,s=4,o=3,r=10,c=4){super(t,e-o,o*2,o*2);const h=Math.hypot(i.x,i.y);this.velocity={x:i.x/h*s,y:i.y/h*s},this.damage=r,this.maxLifeTime=c,this.lifeTime=0}update(t){this.x+=this.velocity.x,this.y+=this.velocity.y,this.lifeTime+=a.deltaTime,this.lifeTime>=this.maxLifeTime&&(this.markForRemoval=!0)}}const d=document.querySelector("#ROTATION_SPEED");var y=.15;d.value="0.15";d.onchange=()=>{y=Number(d.value)};const m={work:{color:"#fbe67f",radiusOffset:5,arcRange:[0,Math.PI/2],lineWidth:6,rotationOffset:-Math.PI/2-Math.PI/4},attack:{color:"#e54b4a",radiusOffset:5.5,arcRange:[0,Math.PI/18],lineWidth:7,rotationOffset:Math.PI/2-Math.PI/18/2}};class w extends f{constructor(t,e,i,s,o=100,r=2){super(t,e,i,s),this.health=o,this.speed=r,this.targetRotation=0,this.currentRotation=0,this.shootTimer=0,this.shootInterval=.1;const c=document.querySelector("#SPEED_INPUT");c.value="2",c.onchange=()=>{this.speed=Number(c.value)}}calculateMovementSub(){let t=0,e=0;a.keys.w&&(e-=1),a.keys.s&&(e+=1),a.keys.a&&(t-=1),a.keys.d&&(t+=1);const i=Math.sqrt(t*t+e*e);if(i<Number.EPSILON)return{x:0,y:0};const s=Number.isFinite(t/i)?t/i:0,o=Number.isFinite(e/i)?e/i:0,r=1e-4;return{x:Math.abs(s)>r?s:0,y:Math.abs(o)>r?o:0}}updateRotation(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].some(r=>a.keys[r])||(t.x!==0||t.y!==0?this.targetRotation=Math.atan2(t.y,t.x):this.targetRotation=this.currentRotation);const s=this.targetRotation-this.currentRotation,o=Math.atan2(Math.sin(s),Math.cos(s));this.currentRotation+=o*y,this.currentRotation=(this.currentRotation%(Math.PI*2)+Math.PI*2)%(Math.PI*2)}updateDirectionalRotation(){const{keys:t}=a;t.ArrowUp&&(this.targetRotation=-Math.PI/2),t.ArrowDown&&(this.targetRotation=Math.PI/2),t.ArrowLeft&&(this.targetRotation=Math.PI),t.ArrowRight&&(this.targetRotation=0),t.ArrowRight&&t.ArrowUp&&(this.targetRotation=-Math.PI/4),t.ArrowRight&&t.ArrowDown&&(this.targetRotation=Math.PI/4),t.ArrowLeft&&t.ArrowUp&&(this.targetRotation=Math.PI+Math.PI/4),t.ArrowLeft&&t.ArrowDown&&(this.targetRotation=Math.PI-Math.PI/4)}applyRotation(t){const e=this.centerPoint;t.translate(e.x,e.y),t.rotate(this.currentRotation-Math.PI/2),t.translate(-e.x,-e.y)}drawComponent(t,e){const{color:i,radiusOffset:s,arcRange:o,lineWidth:r,rotationOffset:c}=m[e],h=this.centerPoint;t.save(),t.translate(h.x,h.y),t.rotate(c),t.translate(-h.x,-h.y),t.beginPath(),t.arc(h.x,h.y,this.width/2+s,o[0],o[1]),t.lineWidth=r,t.strokeStyle=i,t.stroke(),t.restore()}get centerPoint(){return{x:this.x+this.width/2,y:this.y+this.height/2}}getAttackComponentPosition(){return{x:this.centerPoint.x+Math.cos(this.currentRotation)*20,y:this.centerPoint.y+Math.sin(this.currentRotation)*20}}createBullet(){const t=this.getAttackComponentPosition();console.log("attackPos",t),a.addEntity(new p(t.x,t.y,{x:Math.cos(this.currentRotation),y:Math.sin(this.currentRotation)}))}update(t,e){try{const i=this.calculateMovementSub();this.updateDirectionalRotation(),this.updateRotation(i),this.shootTimer+=e||16.67,console.log("this.shootTime",this.shootTimer),console.log("this.shootInterval",this.shootInterval),this.shootTimer>=this.shootInterval&&(this.createBullet(),this.shootTimer-=this.shootInterval),super.update(t,e)}catch(i){console.error("Creep update error:",i)}}draw(t){t.save();try{super.draw(t),this.applyRotation(t),Object.keys(m).forEach(e=>this.drawComponent(t,e))}finally{t.restore()}}}const a={isRunning:!1,entities:[],keys:{},deltaTime:0,lastFrameTime:performance.now(),updateDeltaTime(){const n=performance.now();this.deltaTime=(n-this.lastFrameTime)/1e3,this.lastFrameTime=n},addEntity(n){this.entities.push(n)}};class g{constructor(){this.canvas=null,this.ctx=null,this.animationId=null,this.debugMode=!0,this.initialize()}spawnInitialEntities(){if(!this.ctx||!this.canvas||!this.ctx)return;const t=new w(400,400,15,15);t.draw(this.ctx),a.entities.push(t)}async initialize(){try{await this.waitForDOMReady(),this.setupCanvas(),this.setupEventListeners(),this.spawnInitialEntities(),this.animationId=requestAnimationFrame(t=>this.gameLoop(t))}catch(t){console.error("游戏初始化失败:",t)}}async waitForDOMReady(){document.readyState!=="complete"&&await new Promise(t=>{const e=setTimeout(()=>{console.warn("DOMContentLoaded 等待超时"),t(null)},5e3);document.addEventListener("DOMContentLoaded",()=>{clearTimeout(e),t(null)})})}setupCanvas(){const t=document.querySelector("#GameCanvas");if(!(t instanceof HTMLCanvasElement))throw new Error("无效的Canvas元素");const e=t.getContext("2d",{willReadFrequently:this.debugMode});if(!e)throw new Error("无法获取2D渲染上下文");e.imageSmoothingEnabled=!0;const i=window.devicePixelRatio||1,s=t.getBoundingClientRect();t.width=s.width*i,t.height=s.height*i,e.scale(i,i),t.style.width=`${s.width}px`,t.style.height=`${s.height}px`,this.canvas=t,this.ctx=e,window.addEventListener("resize",()=>this.handleResize())}handleResize(){if(!this.canvas||!this.ctx)return;const t=window.devicePixelRatio||1,e=this.canvas.getBoundingClientRect();this.canvas.width=e.width*t,this.canvas.height=e.height*t,this.ctx.scale(t,t),this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`}setupEventListeners(){const t=s=>{a.keys[s.key]=!0},e=s=>{a.keys[s.key]=!1};window.addEventListener("keydown",t),window.addEventListener("keyup",e);const i=()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",e),window.removeEventListener("beforeunload",i)};window.addEventListener("beforeunload",i)}drawDebugInfo(t){this.ctx&&(this.ctx.fillStyle="yellow",this.ctx.font="12px monospace",this.ctx.fillText(`实体数量: ${a.entities.length}`,10,20),this.ctx.fillText(`帧耗时: ${t.toFixed(2)}ms`,10,35),this.ctx.fillText(`FPS: ${(1e3/t).toFixed(1)}`,10,50))}stopGameLoop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}gameLoop(t){if(a.updateDeltaTime(),!this.canvas||!this.ctx){this.stopGameLoop();return}const e=performance.now();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=100;for(let s=0;s<a.entities.length;s+=i)a.entities=a.entities.filter(r=>!r.markForRemoval),a.entities.slice(s,s+i).forEach(r=>{r.update(this.canvas,a.deltaTime),r.draw(this.ctx)});this.debugMode&&this.drawDebugInfo(performance.now()-e),this.animationId=requestAnimationFrame(s=>this.gameLoop(s))}}new g;
